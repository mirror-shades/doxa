


const input is @read("./advent4.txt")
const split_input :: string[] is split(input, "\n")
const rows is @length(split_input)
const cols is @length(split_input[0])

struct Pair {
    pub x :: int
    pub y :: int
}

entry function main() {
    var grid :: string[][]
    for i while i < rows do i += 1 {
        @push(grid, to_char_array(split_input[i]))
    }

    var accessable_paper :: Pair[]
    var total_accessable_paper :: int is 0
    do {
        accessable_paper is []
        for i while i < rows do i += 1 {
            @print("Checking row {i}\n")
            for j while j < cols do j += 1 {
                if grid[i][j] == "@" then {
                    const maybe_pair is check(i, j, grid, ^accessable_paper)
                    maybe_pair as Pair then {
                        total_accessable_paper += 1
                        @push(accessable_paper, maybe_pair)
                    } else {}
                }
            }
        }
        if (@length(accessable_paper) == 0) then break
        each pair in accessable_paper {
            @print("Marking {pair.x}, {pair.y} as blocked\n")
            grid[pair.x][pair.y] is "."
        }
    }
    total_accessable_paper?
}

function check(i :: int, j :: int, grid :: string[][], ^accessable_paper :: Pair[]) returns Pair | nothing {
    var blocked :: int is 0
    var up_free is true
    var down_free is true
    var left_free is true
    var right_free is true
    if j + 1 >= cols then right_free is false
    if j - 1 < 0 then left_free is false
    if i + 1 > rows - 1 then down_free is false
    if i - 1 < 0 then up_free is false
    if up_free then {
        if grid[i -  1][j] == "@" then {
            blocked += 1
        }
    }
    if down_free then {
        if grid[i + 1][j] == "@" then {
            blocked += 1
        }
    }
    if left_free then {
        if grid[i][j - 1] == "@" then {
            blocked += 1
        }
    }
    if right_free then {
        if grid[i][j + 1] == "@" then {
            blocked += 1
        }
    }
    if right_free and up_free then {
        if grid[i - 1][j + 1] == "@" then {
            blocked += 1
        }
    }
    if right_free and down_free then {
        if grid[i + 1][j + 1] == "@" then {
            blocked += 1
        }
    }
    if left_free and up_free then {
        if grid[i - 1][j - 1] == "@" then {
            blocked += 1
        }
    }
    if left_free and down_free then {
        if grid[i + 1][j - 1] == "@" then {
            blocked += 1
        }
    }

    if blocked < 4 then {
        return $Pair { x is i; y is j }
    }

    return nothing
}

function to_char_array(line :: string) returns string[] {
    var result :: string[]
    var idx is 0
    while idx < @length(line) do idx += 1 {
        @push(result, line[idx])
    }
    return result
}

function split(input :: string, separator :: string) returns string[] {
    if @length(input) == 0 then return []
    
    var result :: string[]
    var start_idx is 0
    var i is 0
    
    while i < @length(input) do i += 1 {
        if input[i] == separator then {
            @push(result, @slice(input, start_idx, i - start_idx) )
            start_idx is i + 1
        }
    }
    
    @push(result, @slice(input, start_idx, @length(input) - start_idx))
    return result
}